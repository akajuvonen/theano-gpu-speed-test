#!/bin/bash -e

# The following gets the absolute path of the project.
# It works regardless of where you run the init script from.
# The absolute path of the script
SCRIPT=$(realpath $0)
# The absolute path of the script directory
SCRIPTDIR=$(dirname $SCRIPT)
# The absolute parent path of the project
PARENTDIR=$(dirname $SCRIPTDIR)

# Run the init script to check for virtualenv and dependencies
$PARENTDIR/bin/init

# Set virtualenv and pythonpath to run the program
cd $PARENTDIR
export PYTHONPATH=.
source $PARENTDIR/env/bin/activate

# Run the file
# The 2>&1 is needed to redirect stderr to stdout
# This way we can capture and parse error messages by theano
OUTPUT=$(THEANO_FLAGS=cuda.root=/usr/local/cuda,device=cuda python src/theano_test.py 2>&1)

# Check output if GNU version is supported
REGEX="unsupported GNU version"
if [[ $OUTPUT =~ $REGEX ]];
then
  echo "ERROR: Use gcc and g++ versions 5 or earlier"
  exit 1
fi

# Otherwise print output
echo $OUTPUT
